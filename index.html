<!DOCTYPE html>
<html lang="es">
<head>
<meta charset="UTF-8">
<title>CRUD con Flask</title>
<style>
body { font-family: Arial, sans-serif; margin:0; height:100vh; }

/* login ocupa toda la pantalla y centra el contenido */
#login {
  display:flex;
  justify-content:center;
  align-items:center;
  height:100vh;
  flex-direction:column;
}

/* app ocupa toda la pantalla, pero está oculto al inicio */
#app {
  display:none;
  height:100vh;
  flex:1;
}

#app.active {
  display:flex;
}

#sidebar { width:200px; background:#333; color:#fff; padding:10px; }
#sidebar button { width:100%; margin:5px 0; padding:8px; cursor:pointer; }
#main { flex:1; padding:20px; overflow:auto; }
.hidden { display:none; }
table { border-collapse:collapse; width:100%; margin-top:10px; }
th, td { border:1px solid #ccc; padding:5px; text-align:left; }
th { background:#eee; }
#topbar { display:flex; justify-content:space-between; align-items:center; margin-bottom:10px; }
#logoutBtn { background:#c00; color:#fff; border:none; padding:6px 10px; cursor:pointer; }

/* modal */
#modal.hidden { display:none; }
#modal {
  position:fixed; top:0; left:0; width:100%; height:100%;
  background:rgba(0,0,0,0.5);
  display:flex; justify-content:center; align-items:center;
}
#modalContent {
  background:#fff; padding:20px; border-radius:8px;
  width:400px; max-height:80vh; overflow:auto;
}
#modalContent input { width:100%; margin-bottom:10px; padding:6px; }
#modalContent label { font-weight:bold; display:block; margin-top:5px; }
#modalContent button { margin-right:10px; }
</style>
</head>
<body>

<!-- Login -->
<div id="login">
  <h2>Iniciar Sesión</h2>
  <input type="text" id="username" placeholder="Usuario"><br>
  <input type="password" id="password" placeholder="Contraseña"><br>
  <button onclick="login()">Entrar</button>
  <p id="loginMsg"></p>
</div>

<!-- App -->
<div id="app">
  <div id="sidebar"></div>
  <div id="main">
    <div id="topbar">
      <h2 id="tituloTabla">Selecciona una tabla</h2>
      <button id="logoutBtn" onclick="logout()">Cerrar Sesión</button>
    </div>
    <div id="acciones"></div>
    <table id="tablaDatos"><thead></thead><tbody></tbody></table>
  </div>
</div>

<!-- Modal -->
<div id="modal" class="hidden">
  <div id="modalContent">
    <h3 id="modalTitle"></h3>
    <form id="modalForm"></form>
    <button onclick="guardar()">Guardar</button>
    <button onclick="cerrarModal()">Cancelar</button>
  </div>
</div>

<script>
let tablas=[
  "TipoUsuario","Compañia","Usuarios","DocumentosPFisicos","Domicilio",
  "PersonasFisicas","DocumentosPMoral","CapitalSocial","FormaAdmin",
  "Apoderados","DomicilioLegal","DomicilioOperativo","PersonaMoral"
];
let tablaActual=null;
let tablasCache={};
let editando=null;

async function login(){
  let username=document.getElementById("username").value;
  let password=document.getElementById("password").value;
  let res=await fetch("http://localhost:5000/login",{
    method:"POST", headers:{"Content-Type":"application/json"},
    body:JSON.stringify({username,password})
  });
  let data=await res.json();
  if(data.success){
    document.getElementById("login").style.display="none";
    document.getElementById("app").classList.add("active");
    renderSidebar();
  } else {
    document.getElementById("loginMsg").innerText="Credenciales inválidas";
  }
}

function logout(){
  document.getElementById("app").classList.remove("active");
  document.getElementById("login").style.display="flex";
  document.getElementById("username").value="";
  document.getElementById("password").value="";
  document.getElementById("loginMsg").innerText="";
}

function renderSidebar(){
  let sb=document.getElementById("sidebar");
  sb.style.display="block";
  sb.innerHTML="<h3>Tablas</h3>";
  tablas.forEach(nombre=>{
    let btn=document.createElement("button");
    btn.innerText=nombre;
    btn.onclick=()=>mostrarTabla(nombre);
    sb.appendChild(btn);
  });
}

async function mostrarTabla(nombre){
  tablaActual=nombre;
  document.getElementById("tituloTabla").innerText="Tabla: "+nombre;
  let res=await fetch("http://localhost:5000/"+nombre);
  let data=await res.json();
  tablasCache[nombre]=data;
  let thead=document.querySelector("#tablaDatos thead");
  let tbody=document.querySelector("#tablaDatos tbody");
  thead.innerHTML=""; tbody.innerHTML="";
  if(!data.length){thead.innerHTML="<tr><th>Sin registros</th></tr>"; return;}
  // Encabezados
  let headerRow=document.createElement("tr");
  Object.keys(data[0]).forEach(k=>{
    let th=document.createElement("th"); th.innerText=k; headerRow.appendChild(th);
  });
  let thAcc=document.createElement("th"); thAcc.innerText="Acciones"; headerRow.appendChild(thAcc);
  thead.appendChild(headerRow);
  // Filas
  data.forEach((row)=>{
    let tr=document.createElement("tr");
    Object.values(row).forEach(val=>{
      let td=document.createElement("td"); td.innerText=val; tr.appendChild(td);
    });
    let tdAcc=document.createElement("td");
    let keys=Object.keys(row);
    let idcol=keys[0]; // asumimos la primera columna como PK
    let idval=row[idcol];
    tdAcc.innerHTML = `<button onclick='editar("${idcol}", "${String(idval).replace(/"/g, '\\"')}")'>Editar</button>
                   <button onclick='eliminar("${idcol}", "${String(idval).replace(/"/g, '\\"')}")'>Eliminar</button>`;
    tr.appendChild(tdAcc);
    tbody.appendChild(tr);
  });
  document.getElementById("acciones").innerHTML=`<button onclick="agregar()">Agregar registro</button>`;
}

function abrirModal(titulo, datos=null){
  document.getElementById("modalTitle").innerText=titulo;
  let form=document.getElementById("modalForm");
  form.innerHTML="";
  let campos = datos ? Object.keys(datos) : Object.keys(tablasCache[tablaActual][0]||{});
  campos.forEach(c=>{
    let val = datos ? (datos[c]??"") : "";
    form.innerHTML += `<label>${c}</label><input name="${c}" value="${val}">`;
  });
  document.getElementById("modal").classList.remove("hidden");
}

function cerrarModal(){
  document.getElementById("modal").classList.add("hidden");
  editando=null;
}

function agregar(){
  abrirModal("Agregar registro");
  editando={modo:"agregar"};
}

async function editar(idcol, idval){
  let res = await fetch(`http://localhost:5000/${tablaActual}/${idcol}/${encodeURIComponent(idval)}`);
  let datos = await res.json();
  abrirModal("Editar registro", datos);
  editando = {modo: "editar", idcol, idval};
}

async function eliminar(idcol, idval){
  await fetch(`http://localhost:5000/${tablaActual}/${idcol}/${encodeURIComponent(idval)}`, {
    method: "DELETE"
  });
  mostrarTabla(tablaActual);
}


async function guardar(){
  let form=document.getElementById("modalForm");
  let data={};
  [...form.elements].forEach(el=>{
    if(el.name) data[el.name]=el.value || null;
  });

  if(editando.modo==="agregar"){
    await fetch("http://localhost:5000/"+tablaActual,{
      method:"POST", headers:{"Content-Type":"application/json"},
      body:JSON.stringify(data)
    });
  } else {
    await fetch(`http://localhost:5000/${tablaActual}/${editando.idcol}/${encodeURIComponent(editando.idval)}`,{
      method:"PUT", headers:{"Content-Type":"application/json"},
      body:JSON.stringify(data)
    });
  }

  cerrarModal();
  mostrarTabla(tablaActual);
}

</script>
</body>
</html>
